@model GamesPlatform.DTOs.UserDetailsDTO

@{
    ViewData["Title"] = "User details - " + (Model?.UserName ?? "User");
    var libGames = Model.LibGames ?? Enumerable.Empty<GamesPlatform.Models.LibGame>();
    var reviews = Model.Reviews ?? Enumerable.Empty<GamesPlatform.Models.Review>();
    var ratings = Model.Ratings ?? Enumerable.Empty<GamesPlatform.Models.Rating>();
    var libGameIds = new HashSet<int>(libGames.Select(l => l.GameId));
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@Model.UserName</h1>
    </div>

    <section class="mb-5">
        <h3>Library (@libGames.Count())</h3>

        @if (libGames.Any())
        {
            <div class="row">
                @foreach (var lg in libGames)
                {
                    var g = lg.Game;
                    var userReview = reviews.FirstOrDefault(r => r.GameId == lg.GameId);
                    var userRating = ratings.FirstOrDefault(rt => rt.GameId == lg.GameId);

                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            @if (!string.IsNullOrEmpty(g?.ThumbNailUrl))
                            {
                                <a asp-controller="Games" asp-action="Game" asp-route-id="@lg.GameId">
                                    <img src="@g.ThumbNailUrl" class="card-img-top" alt="@g?.Title" style="object-fit:cover; height:180px;" />
                                </a>
                            }
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">
                                    <a asp-controller="Games" asp-action="Game" asp-route-id="@lg.GameId" class="stretched-link text-decoration-none">
                                        @(g?.Title ?? $"GameId: {lg.GameId}")
                                    </a>
                                </h5>
                                <p class="mb-1 text-muted">Status: @lg.Status</p>
                                <div class="mt-auto">
                                    @if (userRating != null)
                                    {
                                        <div class="mb-2">
                                            <strong>Rating:</strong>
                                            <span class="badge bg-info text-dark ms-2">G: @userRating.Gameplay</span>
                                            <span class="badge bg-info text-dark ms-1">Gr: @userRating.Graphics</span>
                                            <span class="badge bg-info text-dark ms-1">O: @userRating.Optimization</span>
                                            <span class="badge bg-info text-dark ms-1">S: @userRating.Story</span>
                                        </div>
                                    }
                                    @if (userReview != null)
                                    {
                                        <div class="small text-truncate" title="@userReview.Description">
                                            <strong>Review:</strong> @userReview.Description
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted">Brak gier w bibliotece.</p>
        }
    </section>

    <hr />

    <section class="mb-5">
        <h3>Reviews & Ratings</h3>

        @{
            // zbiór gameId, które już pokazaliśmy w bibliotece
            var shownGameIds = libGameIds;

            // przygotuj listę wszystkich gameId z reviews i ratings, których jeszcze nie pokazaliśmy
            var otherGameIds = new HashSet<int>(
                reviews.Select(r => r.GameId)
                       .Concat(ratings.Select(rt => rt.GameId))
                       .Where(id => !shownGameIds.Contains(id))
            );

            if (!otherGameIds.Any())
            {
                <p class="text-muted">Brak dodatkowych recenzji ani ocen.</p>
            }
            else
            {
                <div class="row">
                    @foreach (var gid in otherGameIds)
                    {
                        var reviewForGame = reviews.FirstOrDefault(r => r.GameId == gid);
                        var ratingForGame = ratings.FirstOrDefault(rt => rt.GameId == gid);
                        var gameTitle = reviewForGame?.Game?.Title ?? ratingForGame?.Game?.Title ?? $"GameId: {gid}";
                        var thumb = reviewForGame?.Game?.ThumbNailUrl ?? ratingForGame?.Game?.ThumbNailUrl;

                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm">
                                @if (!string.IsNullOrEmpty(thumb))
                                {
                                    <a asp-controller="Games" asp-action="Game" asp-route-id="@gid">
                                        <img src="@thumb" class="card-img-top" alt="@gameTitle" style="object-fit:cover; height:180px;" />
                                    </a>
                                }
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">
                                        <a asp-controller="Games" asp-action="Game" asp-route-id="@gid" class="stretched-link text-decoration-none">
                                            @gameTitle
                                        </a>
                                    </h5>

                                    @if (ratingForGame != null)
                                    {
                                        <div class="mb-2">
                                            <strong>Rating:</strong>
                                            <span class="badge bg-info text-dark ms-2">G: @ratingForGame.Gameplay</span>
                                            <span class="badge bg-info text-dark ms-1">Gr: @ratingForGame.Graphics</span>
                                            <span class="badge bg-info text-dark ms-1">O: @ratingForGame.Optimization</span>
                                            <span class="badge bg-info text-dark ms-1">S: @ratingForGame.Story</span>
                                        </div>
                                    }

                                    @if (reviewForGame != null)
                                    {
                                        <div class="small text-truncate" title="@reviewForGame.Description">
                                            <strong>Review:</strong> @reviewForGame.Description
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </section>
</div>
